# Настройка уведомлений Telegram

## Описание

Система ежедневных уведомлений для напоминания о внесении показаний счётчиков.

### Логика работы:

1. **Когда:** Каждый день с 19-го числа месяца в 12:00 по МСК (09:00 UTC)
2. **Что проверяется:** Наличие показаний счётчиков за текущий месяц
3. **Кому отправляется:** Всем активным сотрудникам с привязанным Telegram
4. **Если все данные заполнены:** Уведомления не отправляются

### Формат уведомления:

```
⚠️ Напоминание: внесите показания счётчиков

За февраль 2026 не внесены данные по следующим объектам:

1. САУНА
   Титова 27А

2. 56456456
   6546546

Пожалуйста, внесите показания счётчиков в системе Энергомониторинг.
```

---

## Шаг 1: Деплой Edge Function

### Через Supabase Dashboard (рекомендуется):

1. Откройте **Supabase Dashboard** → **Edge Functions**
2. Нажмите **"Deploy a new function"** → **"Via Editor"**
3. **Function name**: `telegram-notifications`
4. **Region**: Europe West (или ближайший)
5. Скопируйте код из `supabase/functions/telegram-notifications/index.ts`
6. Вставьте в редактор
7. Нажмите **"Deploy"**

### Или через CLI (если установлен):

```bash
cd "C:\Users\Admin\Downloads\Alena"
supabase functions deploy telegram-notifications --no-verify-jwt
```

---

## Шаг 2: Настройка Cron расписания

### В Supabase Dashboard:

1. Откройте **Project Settings** → **Edge Functions**
2. Найдите функцию **telegram-notifications**
3. В разделе **"Cron Jobs"** нажмите **"Add Cron Job"**
4. Введите:
   - **Name**: `daily-notifications`
   - **Schedule**: `0 9 * * *` (каждый день в 09:00 UTC = 12:00 МСК)
   - **Function**: `telegram-notifications`
5. Сохраните

### Альтернатива: Использовать внешний Cron

Если в Supabase нет встроенного Cron, используйте:

**Вариант 1: GitHub Actions**

Создайте файл `.github/workflows/telegram-notifications.yml`:

```yaml
name: Telegram Notifications

on:
  schedule:
    - cron: '0 9 * * *'  # Каждый день в 09:00 UTC (12:00 МСК)

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Call Edge Function
        run: |
          curl -X POST https://YOUR_PROJECT_ID.supabase.co/functions/v1/telegram-notifications
```

**Вариант 2: Cron-job.org**

1. Зарегистрируйтесь на https://cron-job.org
2. Создайте новое задание:
   - **URL**: `https://YOUR_PROJECT_ID.supabase.co/functions/v1/telegram-notifications`
   - **Schedule**: Каждый день в 09:00 UTC
   - **Method**: POST
3. Активируйте задание

**Вариант 3: EasyCron.com**

1. Зарегистрируйтесь на https://www.easycron.com
2. Создайте Cron job:
   - **URL**: `https://YOUR_PROJECT_ID.supabase.co/functions/v1/telegram-notifications`
   - **Cron expression**: `0 9 * * *`
3. Активируйте

---

## Шаг 3: Тестирование

### Ручной запуск (для проверки):

Откройте в браузере или выполните через curl:

```bash
curl -X POST https://YOUR_PROJECT_ID.supabase.co/functions/v1/telegram-notifications
```

**Ожидаемый ответ:**

Если сегодня **< 19 числа**:
```json
{
  "message": "Not notification period yet"
}
```

Если сегодня **>= 19 числа** и **есть объекты без данных**:
```json
{
  "message": "Notifications sent",
  "objectsWithoutData": 2,
  "employeesNotified": 1,
  "totalEmployees": 1
}
```

Если **все данные заполнены**:
```json
{
  "message": "All data filled, no notifications sent"
}
```

### Проверка логов:

Supabase Dashboard → **Edge Functions** → **telegram-notifications** → **Logs**

---

## Логика проверки данных

Функция проверяет:

1. **Активные объекты** (`is_active = true`)
2. **Активные счётчики** этих объектов (`is_active = true`)
3. **Показания** за текущий месяц в таблице `meter_readings`

**Объект считается "без данных"**, если:
- У него есть хотя бы один активный счётчик
- И нет **ни одного** показания за текущий месяц

**Если у объекта нет счётчиков** — он пропускается (не считается проблемным).

---

## Настройка времени отправки

Функция использует **московское время (МСК = UTC+3)**.

**Текущее расписание:**
- Запуск: 09:00 UTC = **12:00 МСК**
- Период: с **19-го числа** каждого месяца

**Изменить время:**

В Cron выражении `0 9 * * *`:
- Первая цифра — минуты (0)
- Вторая цифра — часы UTC (9 = 12:00 МСК)

Примеры:
- `0 6 * * *` = 09:00 МСК
- `0 12 * * *` = 15:00 МСК
- `30 9 * * *` = 12:30 МСК

**Изменить начальную дату:**

В коде функции, строка:
```typescript
if (dayOfMonth < 19) {
```

Замените `19` на нужное число месяца.

---

## Отключение уведомлений

### Временно:
Удалите Cron job в Supabase Dashboard или деактивируйте на внешнем сервисе.

### Навсегда:
Удалите Edge Function `telegram-notifications`.

---

## Troubleshooting

### Уведомления не приходят

1. **Проверьте дату**: Уведомления начинаются с 19-го числа
2. **Проверьте данные**: Если все показания внесены — уведомлений не будет
3. **Проверьте Telegram привязку**: У сотрудников должен быть `tg_id`
4. **Проверьте логи**: Edge Functions → Logs

### Уведомления приходят не всем

- Убедитесь, что у сотрудников заполнено поле `tg_id`
- Проверьте `is_active = true` для сотрудников

### Неправильное время отправки

- Проверьте Cron выражение
- Учитывайте разницу UTC / МСК (+3 часа)

---

## Кастомизация сообщения

Отредактируйте код функции, секцию:

```typescript
let message = `⚠️ <b>Напоминание: внесите показания счётчиков</b>\n\n`;
message += `За <b>${monthName} ${currentYear}</b> не внесены данные по следующим объектам:\n\n`;
```

Можно изменить:
- Эмодзи
- Текст заголовка
- Формат списка объектов
- Добавить ссылку на приложение

---

## Будущие улучшения

- ✅ Персонализированные уведомления (каждому сотруднику только его объекты)
- ✅ Уведомления для конкретных объектов по ответственному сотруднику
- ✅ Напоминания перед дедлайном (например, 25-го числа)
- ✅ Статистика: сколько объектов заполнено / осталось
- ✅ Кнопки в Telegram для быстрого внесения данных
