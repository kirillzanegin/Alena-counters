# MASTER SYSTEM PLAN

## 1. Назначение системы
Внутреннее веб‑приложение (SPA) для сотрудников компании учета энергоресурсов. Назначение: ввод показаний счетчиков, управление объектами учета, просмотр статистики. Публичного доступа нет.

## 2. Технологический стек
- Frontend: SPA (React)
- Auth: Supabase Auth (email + пароль)
- Backend / DB: Supabase (PostgreSQL)
- Клиенты: браузер (desktop + mobile)
- Дополнительно: интеграция с Telegram (привязка аккаунта)

## 3. Пользователи
- Сущность: employees
- Авторизация: email + пароль
- Проверки при входе:
  - наличие записи в employees
  - is_active = true
- Роли: временно не используются (все права одинаковые)

## 4. Сущности БД (актуальные)

### employees
- id
- auth_user_id (Supabase Auth)
- email
- tg_id (nullable, для привязки Telegram)
- first_name, last_name
- role (не используется логикой)
- is_active
- created_at

### objects
- id
- object_name (обязательно)
- object_address (обязательно)
- area (optional)
- contacts
- contacts_area
- comments
- responsible_employee_id
- is_active
- created_at

### counters
- id
- object_id
- counter_type (enum)
- counter_number
- is_active
- created_at

### meter_readings
- id
- counter_id
- indication
- difference (nullable, не используется)
- reading_date (выбирается пользователем)
- submitted_by_employee_id
- created_at
- unique(counter_id, reading_date)

## 5. Навигация (главное меню — плитки)
- Внести показания
- Создать объект
- Редактировать объект
- Статистика (пока заглушка)
- Архив

## 6. Экран «Внести показания» (ключевой)

### 6.1 Поиск объекта
- Поиск по object_name и object_address
- Показываются только objects.is_active = true

### 6.2 Просмотр объекта
- Отображаются все поля объекта

### 6.3 Ввод показаний
- Выбор даты (calendar picker)
- Список активных счетчиков объекта
- Поле indication для каждого счетчика
- Сохранение:
  - INSERT в meter_readings
  - submitted_by_employee_id = текущий сотрудник
  - обработка конфликта unique(counter_id, reading_date)

## 7. Экран «Создать объект»
- Форма создания объекта (поля = objects)
- Выбор типов счетчиков (enum)
- При сохранении:
  - INSERT в objects
  - INSERT выбранных counters

## 7A. Экран «Редактировать объект»
- Выбор объекта (поиск/список, сортировка по алфавиту)
- Редактирование данных объекта:
  - Форма редактирования всех полей
  - Кнопка "Сохранить изменения"
  - Кнопка "Перейти к редактированию показаний"
  - Кнопка "Перенести в архив" (архивирование объекта)
- Редактирование показаний:
  - Выбор месяца
  - Отображение всех показаний счётчиков за месяц
  - Редактирование даты и значения показаний
  - Сохранение изменений

## 8. Экран «Архив»
- Автоматическая загрузка объектов с is_active = false
- Сортировка по алфавиту
- Карточки объектов с информацией
- Возможности:
  - Просмотр деталей объекта
  - Редактирование всех полей
  - Сохранение изменений (UPDATE)
  - Реактивация объекта (восстановление):
    - Подтверждение действия
    - UPDATE is_active = true
    - Автоматическое обновление списка

## 9. Экран «Статистика»
- Выбор объекта (поиск/список, сортировка по алфавиту)
- Выбор периода (месяц "от" и "до")
- Таблица показаний:
  - Строки: счётчики объекта (тип + номер)
  - Колонки: месяцы периода
  - Значения: последнее показание за месяц
  - Прочерк "—" если данных нет
  - Фиксированная первая колонка
  - Горизонтальная прокрутка

## 10. Telegram (закладываем сразу)

### Привязка аккаунта
1. Пользователь авторизован в SPA
2. Нажимает «Привязать Telegram»
3. Получает deep‑link / токен
4. Переходит в Telegram‑бот
5. tg_id сохраняется в employees

### Назначение
- альтернативный вход
- уведомления
- будущий ввод данных

## 11. Принципы реализации
- SPA без перезагрузок
- Нет удаления данных — только is_active
- Один главный рабочий экран — «Внести показания»
- Реализация по блокам
- Каждый блок отмечается как DONE

