# ‚úÖ –ó–ê–î–ê–ß–ê –î–õ–Ø –°–õ–ï–î–£–Æ–©–ï–ì–û –ê–ì–ï–ù–¢–ê

## üéØ –¶–ï–õ–¨:
–î–æ–¥–µ–ª–∞—Ç—å **–Ω–æ–≤—ã–π —Å–ø–æ—Å–æ–± –ø—Ä–∏–≤—è–∑–∫–∏ Telegram** (–∏–∑ Telegram ‚Üí –∫–æ–¥ ‚Üí –≤—Ö–æ–¥ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí –≤–≤–æ–¥ –∫–æ–¥–∞)

---

## ‚úÖ –ß–¢–û –†–ê–ë–û–¢–ê–ï–¢ –°–ï–ô–ß–ê–°:

1. ‚úÖ –°—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–±: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ ‚Üí –±–æ—Ç
2. ‚úÖ –ö–Ω–æ–ø–∫–∞ –≤ UI (–∫—Ä–∞—Å–Ω–∞—è/—Å–∏–Ω—è—è)
3. ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (–µ—Å—Ç—å –ø–æ–ª–µ `tg_id`)
4. ‚úÖ –ö–æ–¥ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Å–ø–æ—Å–æ–±–∞ –Ω–∞–ø–∏—Å–∞–Ω

---

## ‚ö†Ô∏è –ß–¢–û –ù–ï –†–ê–ë–û–¢–ê–ï–¢:

–ù–æ–≤—ã–π —Å–ø–æ—Å–æ–± **–Ω–∞–ø–∏—Å–∞–Ω**, –Ω–æ **–Ω–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω**:
- –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –ø—Ä–∏ `/start`
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —ç–∫—Ä–∞–Ω –≤–≤–æ–¥–∞ –∫–æ–¥–∞ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞
- –ù—É–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –æ—Ç–ª–∞–¥–∏—Ç—å

---

## üìù –ß–¢–û –î–ï–õ–ê–¢–¨:

### –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç—å Edge Function

**–§–∞–π–ª:** `supabase/functions/telegram-webhook/index.ts`

1. Supabase Dashboard ‚Üí Edge Functions ‚Üí telegram-webhook
2. Edit ‚Üí –≤—Å—Ç–∞–≤–∏—Ç—å –∫–æ–¥ –∏–∑ `index.ts` (–ø–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è)
3. Deploy
4. **–ö–†–ò–¢–ò–ß–ù–û:** Settings ‚Üí **Verify JWT ‚Üí –û–¢–ö–õ–Æ–ß–ò–¢–¨** ‚úÖ
5. –¢–µ—Å—Ç: `/start` ‚Üí –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å —Å –∫–æ–¥–æ–º

---

### –®–∞–≥ 2: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π —Å–ø–æ—Å–æ–±

1. Telegram ‚Üí `/start` –±–æ—Ç—É
2. –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ (6 —Ü–∏—Ñ—Ä)
3. –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí –≤—ã–π—Ç–∏ (–µ—Å–ª–∏ –≤–æ—à–ª–∏)
4. –í–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ
5. **–î–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è —ç–∫—Ä–∞–Ω –≤–≤–æ–¥–∞ –∫–æ–¥–∞**
6. –í–≤–µ—Å—Ç–∏ –∫–æ–¥ ‚Üí "–ü—Ä–∏–≤—è–∑–∞—Ç—å Telegram"
7. –î–æ–ª–∂–Ω–æ —Å—Ä–∞–±–æ—Ç–∞—Ç—å ‚úÖ

---

### –®–∞–≥ 3: –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –æ—Ç–ª–∞–¥–∫–∞

**–ü—Ä–æ–±–ª–µ–º–∞: –≠–∫—Ä–∞–Ω –∫–æ–¥–∞ –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å: `fetchEmployeeForUser result: {tg_id: null}`
- –í `app.js` —Å—Ç—Ä–æ–∫–∞ 121: `.select("id, first_name, last_name, is_active, tg_id")`
- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç `TelegramCodePrompt` —Å—Ç—Ä–æ–∫–∞ ~4339

**–ü—Ä–æ–±–ª–µ–º–∞: –ö–æ–¥ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è**
- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–∞–±–ª–∏—Ü—É `telegram_link_tokens`: –µ—Å—Ç—å –ª–∏ –∑–∞–ø–∏—Å—å —Å `tg_id != NULL`?
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Edge Function

**–ü—Ä–æ–±–ª–µ–º–∞: –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç**
- `getWebhookInfo` ‚Üí –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞
- –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —Å–Ω–æ–≤–∞ –≤–∫–ª—é—á–∏–ª—Å—è "Verify JWT" ‚Üí –æ—Ç–∫–ª—é—á–∏—Ç—å

---

## üîë –ö–õ–Æ–ß–ï–í–´–ï –ú–û–ú–ï–ù–¢–´:

### 1. **Verify JWT –í–°–ï–ì–î–ê –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –û–¢–ö–õ–Æ–ß–ï–ù**
–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–µ–ø–ª–æ—è –ø—Ä–æ–≤–µ—Ä—è—Ç—å!

### 2. **–î–≤–∞ —Å–ø–æ—Å–æ–±–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ:**
- –°–ø–æ—Å–æ–± 1: `employee_id != NULL`, `tg_id = NULL` (–∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
- –°–ø–æ—Å–æ–± 2: `employee_id = NULL`, `tg_id != NULL` (–∏–∑ Telegram)

### 3. **Webhook –º–æ–∂–µ—Ç –æ—Ç–≤–∞–ª–∏–≤–∞—Ç—å—Å—è:**
–ü—Ä–æ–≤–µ—Ä–∫–∞: `api.telegram.org/bot8477674658:AAHdZS8bGIKINlXawLoNJiuukywWQgAt3E0/getWebhookInfo`

---

## üìÅ –§–ê–ô–õ–´:

```
app.js                                        # TelegramCodePrompt –¥–æ–±–∞–≤–ª–µ–Ω
telegram-webhook/index.ts                     # –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è (–æ–±–∞ —Å–ø–æ—Å–æ–±–∞)
telegram-webhook/index-WORKING-OLD.ts         # –û—Ç–∫–∞—Ç (—Ç–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–± 1)
SQL_UPDATE_TELEGRAM_TOKENS.sql                # SQL –≤—ã–ø–æ–ª–Ω–µ–Ω ‚úÖ
HANDOFF_TO_NEXT_AGENT.md                      # –ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (—ç—Ç–æ—Ç —Ñ–∞–π–ª)
```

---

## üöÄ –ë–´–°–¢–†–´–ô –°–¢–ê–†–¢:

```
1. –û–±–Ω–æ–≤–∏—Ç—å telegram-webhook (index.ts)
2. –û—Ç–∫–ª—é—á–∏—Ç—å Verify JWT
3. –ù–∞–ø–∏—Å–∞—Ç—å /start –±–æ—Ç—É
4. –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥
5. –í–æ–π—Ç–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
6. –í–≤–µ—Å—Ç–∏ –∫–æ–¥
7. ‚úÖ –ü—Ä–∏–≤—è–∑–∫–∞!
```

---

## ‚ö° –ï–°–õ–ò –ó–ê–°–¢–†–Ø–õ:

- –õ–æ–≥–∏ Edge Function –ø–æ–∫–∞–∂—É—Ç –æ—à–∏–±–∫–∏
- –ö–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –ø–æ–∫–∞–∂–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã –≤ app.js
- getWebhookInfo –ø–æ–∫–∞–∂–µ—Ç —Å—Ç–∞—Ç—É—Å webhook

---

**–£–î–ê–ß–ò!** üéâ
