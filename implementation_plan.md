# IMPLEMENTATION PLAN (ПОШАГОВО)

Реализация ведётся строго по шагам. Следующий шаг начинается только после фиксации DONE.

---

## Блок 01 — Авторизация
- Подключить Supabase
- Реализовать email + password login
- Проверка employees.is_active
- Logout

Статус: DONE

---

## Блок 02 — Главное меню (плитки)
- Экран после входа
- Плитки:
  - Внести показания
  - Создать объект
  - Статистика
  - Архив

### 2.1 Маршруты и переходы
- После успешной авторизации перенаправлять пользователя на маршрут `/app` (главный экран).
- Страница `/app` доступна только для авторизованных пользователей (проверка сессии Supabase).
- Настроить маршруты для плиток:
  - `/app/readings` — экран «Внести показания».
  - `/app/objects/new` — экран «Создать объект».
  - `/app/objects/edit` — экран «Редактировать объект».
  - `/app/stats` — экран «Статистика».
  - `/app/archive` — экран «Архив».

### 2.2 Структура экрана
- Общий layout для внутренних экранов:
  - верхняя панель с названием приложения;
  - отображение имени текущего сотрудника (по данным `employees`);
  - кнопка Logout (использует логику из Блока 01).
- Основная область экрана `/app` содержит сетку плиток (4 штуки).

### 2.3 Компонент плитки
- Создать переиспользуемый компонент `MenuTile`:
  - иконка (placeholder на v1);
  - заголовок;
  - краткое описание;
  - обработчик клика (переход на нужный маршрут).
- Реализовать плитки:
  - «Внести показания» — основной CTA, визуально выделена;
  - «Создать объект»;
  - «Редактировать объект» — редактирование данных объекта и показаний;
  - «Статистика» (в v1 ведёт на заглушку из Блока 06);
  - «Архив».

### 2.4 Поведение и ограничения
- Если по какой‑то причине пользователь не авторизован (нет сессии / токен просрочен), при открытии любого маршрута `/app/*` выполнять редирект на экран логина.
- Не загружать данные из БД на главном экране — только навигация.
- Вёрстка адаптивная: плитки корректно отображаются на desktop и мобильных браузерах.

Статус: DONE

---

## Блок 03 — Внести показания

### 3.1 Поиск объекта
- Автоматическая загрузка всех активных объектов при открытии экрана
- Сортировка объектов по алфавиту (по названию)
- Поле поиска для фильтрации по name / address
- Только is_active = true
- Кнопка очистки поиска для возврата ко всем объектам

### 3.2 Выбор объекта
- Отображение данных объекта

### 3.3 Ввод показаний
- Date picker (по умолчанию — текущая дата)
- Список активных счётчиков объекта
- Отображение типа счётчика и номера прибора (если указан)
- Поля indication для каждого счётчика
- Сохранение в meter_readings
- Обработка конфликта уникальности (counter_id, reading_date)

Статус: DONE

---

## Блок 04 — Создать объект
- Форма objects (название, адрес, площадь, контакты, комментарии)
- Чекбоксы для выбора типов счётчиков (16 типов)
- Опциональное поле "Номер прибора" для каждого выбранного счётчика
- Создание объекта и счётчиков одной транзакцией

Статус: DONE

---

## Блок 04A — Редактировать объект

### 4A.1 Выбор объекта
- Автоматическая загрузка всех активных объектов
- Поиск по названию/адресу
- Сортировка по алфавиту

### 4A.2 Редактирование данных объекта
- Форма редактирования всех полей объекта
- Кнопка "Сохранить изменения" (UPDATE в objects)
- Кнопка "Перенести в архив" (UPDATE is_active = false):
  - Подтверждение действия (confirm)
  - Уведомление об успехе
  - Автоматический возврат в меню через 1.5 сек
- Уведомления об успехе/ошибке

### 4A.3 Редактирование показаний
- Кнопка "Перейти к редактированию показаний"
- Выбор месяца (date picker, тип month)
- Загрузка всех показаний счётчиков за выбранный месяц
- Отображение: тип счётчика, номер прибора
- Редактирование каждого показания:
  - Поле "Дата" (date picker) - можно изменить дату показания
  - Поле "Показание" (number) - можно изменить значение
- Сохранение изменений (UPDATE в meter_readings)
- Автоматическое обновление списка после сохранения

Статус: DONE

---

## Блок 05 — Архив

### 5.1 Список архивных объектов
- Автоматическая загрузка объектов с is_active = false
- Сортировка по алфавиту (по названию)
- Отображение карточек объектов
- Счётчик объектов в архиве

### 5.2 Просмотр и редактирование
- Отображение всех данных объекта
- Форма редактирования:
  - Название объекта
  - Адрес
  - Площадь
  - Контакты
  - Комментарии
- Сохранение изменений (UPDATE в objects)

### 5.3 Реактивация объекта
- Кнопка "Восстановить объект"
- Подтверждение действия (confirm)
- UPDATE is_active = true
- Автоматическое удаление из списка архива после восстановления
- Уведомление об успехе

Статус: DONE

---

## Блок 06 — Статистика

### 6.1 Выбор объекта
- Автоматическая загрузка всех активных объектов
- Поиск по названию/адресу
- Сортировка по алфавиту

### 6.2 Выбор периода
- Поле "Начало периода" (month picker)
- Поле "Конец периода" (month picker)
- По умолчанию: последние 3 месяца
- Валидация: начало не может быть позже конца
- Кнопка "Показать статистику"

### 6.3 Таблица показаний
- Строки: все активные счётчики объекта
  - Тип счётчика
  - Номер прибора (если указан)
- Колонки: месяцы выбранного периода
  - Формат: "Январь 2026", "Февраль 2026" и т.д.
- Ячейки: показания счётчика за месяц
  - Если показание есть — отображается последнее значение за месяц
  - Если показания нет — прочерк "—"
- Фиксированная первая колонка (sticky) для удобной прокрутки
- Горизонтальная прокрутка при большом количестве месяцев
- Hover-эффект на строках

Статус: DONE

---

## Блок 07 — Привязка Telegram

### 7.1 UI в приложении
- Плитка "Telegram" в главном меню
- Экран привязки с генерацией токена
- Deep-link на бота: `https://t.me/money_cheking_bot?start=TOKEN`
- Отображение статуса привязки (привязан/не привязан)
- Кнопка "Отвязать Telegram" для привязанных аккаунтов

### 7.2 База данных
- Таблица `telegram_link_tokens`:
  - `id` (UUID)
  - `employee_id` (UUID, FK)
  - `token` (TEXT, уникальный)
  - `created_at` (timestamp)
  - `expires_at` (timestamp, срок действия 1 час)
  - `used` (boolean)
- RLS политики для безопасности
- Индексы для быстрого поиска по токену

### 7.3 Supabase Edge Function
- Путь: `supabase/functions/telegram-webhook/index.ts`
- Обработка webhook от Telegram API
- Команды:
  - `/start TOKEN` - привязка аккаунта
  - `/start` - приветствие и инструкции
  - `/help` - справка
  - `/status` - проверка статуса привязки
- Проверка токена, срока действия, уникальности
- Сохранение `tg_id` в таблице `employees`

### 7.4 Telegram Bot
- Username: `@money_cheking_bot`
- Token: `8477674658:AAHdZS8bGIKINlXawLoNJiuukywWQgAt3E0`
- Webhook настроен на Edge Function
- Поддержка HTML форматирования сообщений

### 7.5 Инструкции по настройке
- Файл `TELEGRAM_SETUP.md` с пошаговыми инструкциями:
  - Создание таблицы в БД
  - Установка Supabase CLI
  - Деплой Edge Function
  - Настройка webhook
  - Тестирование и troubleshooting

Статус: DONE

